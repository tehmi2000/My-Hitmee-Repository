const online_users=[];let no_of_unread_msg=0,current_section="";Object.defineProperty(Array.prototype,"last",{get:function(){return this[this.length-1]}}),socket.on("add2Chat",(function(data,picture,uID){let msg,f_message,messageData=data.last;if(null!=messageData)switch(messageData.message.type){case"text":f_message=messageData.message.content;break;case"image":f_message="You received an image";break;case"video":f_message="You received a video";break;default:f_message=""}else f_message="<i>No chat. Tap to chat</i>";online_users.forEach(person=>{if(person.id===uID)try{msg=f_message,person.message=msg}catch(e){console.log(e.message)}}),changeMessage("newMsg",msg,"m_"+uID)})),socket.on("newconnect",(function(data){addNewUser(data)})),socket.on("logged out",(function(userID){console.log("Logging out: ",userID),removeUser(userID)})),socket.on("init_chatroom",(function(sessID,buddyName){document.cookie="chattingWith="+buddyName+";",navigatePage("chatroom",sessID,buddyName)})),socket.on("isTyping",(function(data,sender,uID){console.log("receive typing event:",data),changeMessage(!0===data?"typing":"idle","","m_"+uID)})),socket.on("receiveMessage",(function(data,uID){let messageData=data;"text"===messageData.message.type?f_message=messageData.message.content:"image"===messageData.message.type?f_message="You received an image":messageData.message.type,console.log("receive message event:",f_message),no_of_unread_msg++,rearrange(uID),online_users.forEach(person=>{person.id===uID&&(person.unread+=1,person.message=f_message,unread_msg(person.unread,"c_"+uID))}),changeMessage("newMsg",f_message,"m_"+uID)})),socket.on("receiveVideoCall",(function(data,username){if(!0===data.closeConnection){let notification;changeMessage("newMsg","active","t_"+username)}else{let notification;changeMessage("newMsg",'<i style="color:#3bdc3b;"><b>Video Calling...</b></i>',"t_"+username)}})),socket.on("receiveVoiceCall",(function(data,username){if(!0===data.closeConnection){let notification;changeMessage("newMsg","active","t_"+username)}else{let notification;changeMessage("newMsg",'<i style="color:#3bdc3b;"><b>Voice Calling...</b></i>',"t_"+username)}})),document.addEventListener("DOMContentLoaded",(function(event){let nStatus=get("nav_status"),nChat=get("nav_chats"),nCalls=get("nav_games"),nFloatButton=get("add-friend");nFloatButton.setAttribute("onclick","showFriendBox()"),forEach(document.querySelectorAll(".friend-search-box .close"),(function(element){element.addEventListener("click",(function(){document.querySelector("aside.friend-search-box").style.top="calc(0vh - 31vh)"}))})),nStatus.addEventListener("click",(function(evt){forEach(document.querySelectorAll(".active"),elem=>{elem.classList.toggle("active",!1)}),evt.currentTarget.classList.toggle("active",!0),current_section="status",get("sect").style.marginLeft="0%",document.querySelector("#add-friend i").setAttribute("class","icofont-lens"),nFloatButton.removeAttribute("onclick"),nFloatButton.setAttribute("onclick","navigatePage('chatroom')")})),nChat.addEventListener("click",(function(evt){forEach(document.querySelectorAll(".active"),elem=>{elem.classList.toggle("active",!1)}),evt.currentTarget.classList.toggle("active",!0),current_section="chats",get("sect").style.marginLeft="-100%",document.querySelector("#add-friend i").setAttribute("class","icofont-search-user"),nFloatButton.removeAttribute("onclick"),nFloatButton.setAttribute("onclick","showFriendBox()")})),nCalls.addEventListener("click",(function(evt){forEach(document.querySelectorAll(".active"),elem=>{elem.classList.toggle("active",!1)}),evt.currentTarget.classList.toggle("active",!0),current_section="calls",get("sect").style.marginLeft="-200%",document.querySelector("#add-friend i").setAttribute("class","icofont-ui-delete"),nFloatButton.removeAttribute("onclick"),nFloatButton.setAttribute("onclick","navigatePage('chats')")})),""===current_section&&(nChat.classList.toggle("active",!0),current_section="chats"),getCookie("hitmee-username")?(document.querySelector("span#logo > span").innerHTML="YOU",!sessionStorage.getItem("New")&&window.speechSynthesis&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("welcome "+getCookie("hitmee-username").value)),sessionStorage.setItem("New",!0)),setTimeout((function(){getMyFriends()}),500)):window.addEventListener("load",(function(){document.querySelector("span#logo > span").innerHTML="",alert("Unrecognised login session!")}))}));const showFriendBox=function(){document.querySelector("aside.friend-search-box").style.top="calc(50vh - 15vh)"};function showImage(event){let windX=parseInt(window.innerWidth),windY=parseInt(window.innerHeight),dialogWidth=Math.round(.8*min(windX,windY)),dialogHeight=dialogWidth;gsap.fromTo("#dialog",.2,{display:"none",x:event.clientX,y:event.clientY,margin:0,width:0,height:0,opacity:0,borderRadius:"50%"},{display:"flex",x:Math.round((windX-dialogWidth)/2),y:Math.round((windY-dialogHeight-.25*dialogHeight)/2),margin:0,width:dialogWidth,height:dialogHeight,borderRadius:0,opacity:1}),get("dialog_header").innerHTML="~"+event.currentTarget.id,get("dialog_download").href=event.currentTarget.src,get("full-image").src=event.currentTarget.src,get("full-image").addEventListener("click",hideImage)}function hideImage(event){let windX=parseInt(window.innerWidth),dialogWidth=Math.round(.7*windX),return_windX=-1*Math.round((windX-dialogWidth)/2);gsap.to("#dialog",.5,{x:return_windX,y:0,width:0,height:0,opacity:0,borderRadius:"50%",ease:Power0.easeNone,onComplete:function(evt){get("dialog").style.display="none"}}),get("dialog").style.width="0",get("dialog").style.height="0"}function getMyFriends(){fetch(`/api/${getCookie("hitmee-username").value}/getFriends`).then((async function(response){try{let users_online_list=await response.json();console.log(users_online_list),displayUsersOnline(users_online_list)}catch(err){console.error(err)}})).catch((function(error){console.error(error)}))}function displayUsersOnline(array){if(1===array.length&&null===get("no-online")){let div1=createComponent("DIV","No user online");div1.setAttribute("id","no-online"),get("contact_box").appendChild(div1)}else if(array.length>0)for(let index=0;index<array.length;index++)addNewUser(array[index]);else{let div1=createComponent("DIV","Logging you out in 5 seconds...");div1.setAttribute("id","no-online"),get("contact_box").appendChild(div1);let countOut=setTimeout((function(){window.location.replace("/logout"),clearTimeout(countOut)}),4997)}}const addNewUser=function(object){if(object.username!=getCookie("hitmee-username").value){null==get("no-online")&&null==get("no-online")||get("no-online").parentNode.removeChild(get("no-online"));let div1=createComponent("DIV",null,["on_contact"]),img1=createComponent("IMG",null,["user_dp"]),div2=createComponent("DIV",null,["cols","display-container"]),div3=createComponent("DIV",null,["rows"]),span1=createComponent("SPAN",object.username,["chat-name"]),span2=createComponent("SPAN","active",["display-time"]),div4=createComponent("DIV",null,["rows"]),span3=createComponent("SPAN"," ",["chat-message"]),span4=createComponent("SPAN",no_of_unread_msg,["unread-indicator","hide"]),span5=createComponent("SPAN",null,["pass-section"]),button0=createComponent("button",null,["lock-toggle"]),i0=createComponent("i",null,["icofont-lock"]),input0=create("input");img1.src=object.profile_picture,img1.setAttribute("id",object.username),input0.setAttribute("type","password"),img1.addEventListener("click",showImage),0===no_of_unread_msg&&span4.classList.toggle("hide",!0),span2.setAttribute("id","t_"+object.username),span3.setAttribute("id","m_"+object.uID),span4.setAttribute("id","c_"+object.uID),div3=joinComponent(div3,span1,span2),div4=joinComponent(div4,span3,span4),div2=joinComponent(div2,div3,div4),button0=joinComponent(button0,i0),span5=joinComponent(span5,button0,input0),div1=joinComponent(div1,img1,div2,span5),div1.setAttribute("id",`div_${object.uID}`),get("contact_box").appendChild(div1),sessionStorage.getItem("Active Login")||(gsap.from(`#div_${object.uID}`,.1,{marginLeft:"101%"}),sessionStorage.setItem("Active Login",!0)),div2.setAttribute("id",object.uID),div2.onclick=function(event){socket.emit("connectTo",event.currentTarget.id,getCookie("hitmee-username").value)},online_users.push({id:object.uID,username:object.username,message:"",unread:0}),socket.emit("getChat",getCookie("hitmee-username").value,object.username)}},removeUser=function(elementId){let element=get("div_"+elementId);element&&element.parentNode.removeChild(element)};function changeMessage(type,message,id){let status;switch(!0){case"typing"===type:status='<i style="color:#4bec4b;">typing...</i>',get(id).innerHTML=status;break;case"idle"===type:console.log("online: ",online_users,"\n id: ",id),online_users.forEach(person=>{person.id===id&&(get(id).innerHTML=person.message)});break;case"newMsg"===type:status=message,get(id).innerHTML=status;break;default:status="online",get(id).innerHTML=status}}function unread_msg(count,id,bypass){bypass=bypass||!1;let msg=get(id);!1===bypass&&(0===count?msg.classList.toggle("hide",!0):(msg.classList.toggle("hide",!1),msg.innerHTML=count))}function rearrange(id){console.log(id);let wrapper=get("contact_box"),children=wrapper.children,fragment=document.createDocumentFragment();for(let index=0;index<children.length;index++)"aor"===children[index].getAttribute("id")&&fragment.appendChild(children[index].cloneNode(!0)),children[index].getAttribute("id")===id&&fragment.appendChild(children[index].cloneNode(!0));for(let idx=0;idx<children.length;idx++)children[idx].getAttribute("id")!==id&&"aor"!==children[idx].getAttribute("id")&&fragment.appendChild(children[idx].cloneNode(!0));wrapper.innerHTML="",children=null,wrapper.appendChild(fragment),children=wrapper.children;for(let index=0;index<children.length;index++)"aor"===children[index].getAttribute("id")?console.log("children["+index+"] is aor"):(children[index].children[0].addEventListener("click",showImage),children[index].children[1].addEventListener("click",(function(event){socket.emit("connectTo",event.currentTarget.id,getCookie("hitmee-username").value)})))}function search(){let search_string=document.getElementById("search").value;socket.emit("search_friend",getCookie("hitmee-username").value,search_string)}function displaySearch(details){null==document.getElementById("no-search")&&null==document.getElementById("no-search")||document.getElementById("no-search").parentNode.removeChild(document.getElementById("no-search"));try{var div0=document.createElement("DIV"),h=document.createElement("H3"),div0_msg=document.createTextNode("Hitmee found a friend:");h.style.color="rgb(120, 20, 0)",h.appendChild(div0_msg),div0.appendChild(h),document.getElementById("parent_wrap").innerHTML="";var div1=document.createElement("DIV"),div2=document.createElement("DIV");let center=document.createElement("CENTER");var img1=document.createElement("IMG"),div3=document.createElement("DIV"),div5=document.createElement("DIV"),span1=createComponent("SPAN",details.username),span2=createComponent("SPAN","("+details.telcode+") "+details.phone),div6=document.createElement("DIV"),span3=createComponent("SPAN",details.bio),div4=document.createElement("DIV"),button=createComponent("BUTTON","START CHAT");img1.src=details.profile_picture,img1.classList.add("user_dp"),div1.classList.add("on_friend"),div2.classList.add("image"),div3.classList.add("details"),div4.classList.add("chat_button"),span1.classList.add("u"),span2.classList.add("t"),span3.classList.add("u"),center.appendChild(img1),button.setAttribute("id",details.uID),div5=joinComponent(div5,span1,span2),div6.appendChild(span3),div3=joinComponent(div3,div5,div6),div4.appendChild(button),div2.appendChild(center),div1=joinComponent(div1,div2,div3,div4),joinComponent(document.getElementById("parent_wrap"),div0,div1),button.onclick=function(event){socket.emit("addBuddy",event.currentTarget.id,getCookie("hitmee-username").value)}}catch(e){alert(e.message)}}function addFriend(username){socket.emit("addBuddy",username,getCookie("hitmee-username").value)}